## 04 | 导航流程：从输入URL到页面展示，这中间发生了什么？
手动实现
-  输不同内容  
  默认引擎 "特朗普"
  eekbang.org  补全协议
- beforeunload
  html 
- 看菊花图 github   慢
   页
- 缓存 
  iconfont.css  disk cache 
- 域名服务器
  Domain Name Server 
- https  TLS连接
  安全传输层协议（TLS）用于在两个通信应用程序之间提供保密性和数据完整性。传输层安全协议)
- juejin 写文章  cookie 
- curl -I http://time.geekbang.org/
  301  302 执行一下看
- curl -I https://time.geekbang.org/
  200 响应数据类型处理 执行一下看
  Content-Type 是 HTTP 头中一个非常重要的字段， 它告诉浏览器服务器返回的响应体数据是什么类型
  curl -I https://res001.geekbang.org/apps/geektime/android/2.3.1/official/geektime_2.3.1_20190527-2136_offical.apk
  application/octet-stream

- 同一个进程里渲染
  每个标签对应一个渲染进程。但如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点的话，那么新页面会复用父页面的渲染进程。


一道经典的面试题
网络 操作系统  Web
零散的知识点  并不能将这些知识点串联成线 无法系统而又全面地回答这个问题

![](https://static001.geekbang.org/resource/image/92/5d/92d73c75308e50d5c06ad44612bcb45d.png)

整个过程需要各个进程之间的配合
  浏览器进程（chrome 启动）、 用户交互(输入地址)，子进程管理(其他进程)  和文件储存localstorage 静态文件缓存 cookie session 
渲染进程 
  从网络下载的 HTML、JavaScript、CSS、图片等资源解析为可以显示和交互的页面
  网络， 恶意代码利用浏览器漏洞对系统进行攻击 不被信任的  沙箱 猫沙， 保证系统的安全
网络进程
  面向渲染进程和浏览器进程等提供网络下载功能

执行流程
- 首先，浏览器进程接收到用户输入的 URL 请求，浏览器进程便将该 URL 转发给网络进程。
- 然后，在网络进程中发起真正的 URL 请求。
- 接着网络进程接收到了响应头数据，便解析响应头数据，并将数据转发给浏览器进程。
  跳转 
- 浏览器进程接收到网络进程的响应头数据之后，发送“提交导航 (CommitNavigation)”消息到渲染进程；
- 渲染进程接收到“提交导航”的消息之后，便开始准备接收 HTML 数据，接收数据的方式是直接和网络进程建立数据管道；
- 最后渲染进程会向浏览器进程“确认提交”，这是告诉浏览器进程：“已经准备好接受和解析页面数据了”。
- 浏览器进程接收到渲染进程“提交文档”的消息之后，便开始移除之前旧的文档，然后更新浏览器进程中的页面状态。

用户发出 URL 请求到页面开始解析的这个过程，就叫做导航。

1. 用户输入 
  搜索内容，还是请求的 URL。
  - 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 URL
  - 如果判断输入内容符合 URL 规则，比如输入的是 time.geekbang.org，那么地址栏会根据规则，把这段内容加上协议，合成为完整的 URL，如https://time.geekbang.org

2. 替换成新的页面
  beforeunload
  一些数据清理操作 询问用户是否要离开当前页面  比如当前页面可能有未提交完成的表单等情况  beforeunload 事件来取消导航，让浏览器不再执行任何后续工作。

3. loading 状态， 切换进程 菊花图
  等待被替换 提交文档阶段，页面内容才会被替换。

4. URL 请求过程
  页面资源请求过程。这时，浏览器进程会通过进程间通信（IPC）把 URL 请求发送至网络进程，网络进程接收到 URL 请求后，会在这里发起真正的 URL 请求流程。那具体流程是怎样的呢？

  网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程

  ；如果在缓存中没有查找到资源，那么直接进入网络请求流程。这请求前的第一步是要进行 DNS 解析，以获取请求域名的服务器 IP 地址。如果请求协议是 HTTPS，那么还需要建立 TLS 连接。

  IP 地址和服务器建立 TCP 连接
  OSI的7层从上到下分别是 7 应用层(TELNET，HTTP，FTP，NFS，SMTP) 6 表示层 5 会话层 4 传输层 （TCP，UDP）3 网络层 （IP)）2 数据链路层 1 物理层

  浏览器端会构建请求行、请求头等信息 Cookie 等数据附加到请求头中，然后向服务器发送构建的请求信息
  request cookie 信息
  登录信息

  包括响应头和响应体等信息
  并发给网络进程。等网络进程接收了响应行和响应头之后，就开始解析响应头的内容了。

  1 重定向
  301 或者 302，那么说明服务器需要浏览器重定向到其他 URL。这时网络进程会从响应头的 Location 字段里面读取重定向的地址，然后再发起新的 HTTP 或者 HTTPS 请求，一切又重头开始了。

  每打开一个新页面就会配套创建一个新的渲染进程

提交文档所谓提交文档，就是指浏览器进程将网络进程接收到的 HTML 数据提交给渲染进程，具体流程是这样的：

首先当浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起“提交文档”的消息；渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”；等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程；浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面。